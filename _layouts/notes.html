<head>
    {% include head.html %}
    {% include navigation.html %}
    {% include js.html %}
    <link href="{{ site.baseurl }}/assets/css/notes.css" rel="stylesheet">
    <link href="{{ site.baseurl }}/assets/css/highlight.css" rel="stylesheet">
    <script src="{{ site.baseurl }}/assets/js/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>

<body data-spy="scroll" data-target=".sidebar">
    <canvas id="bg-particles" aria-hidden="true"></canvas>
    <div class="wrapper">
        <div class="sidenav navbar">
            <div id="toc"></div>
        </div>

        <div class="main notes-layout">
            <div id="content" class="markdown note-box">
                <!-- <hr> -->
                <p class="title" style="font-size: xx-large; text-align: left; margin-bottom: 0px;">
                    {{ page.title }} <a class="btn btn-primary" style="text-transform: lowercase"
                        href="https://github.com/csinva/csinva.github.io/blob/master/{{ page.path }}">view
                        markdown <i class="fa fa-github fa-fw"></i></a>
                    {% if page.subtitle %}
                <p class="subtitle" style="font-size: large; text-align: left;">{{page.subtitle }}</p>
                {% endif %}
                </p>
                <hr style="width: 100%;">
                {{ page.content | markdownify }}
                <!-- Check if page has attribute subtitle -->

                <hr>
                <br />
                <br />
            </div>
        </div>

    </div>

</body>

<style>
    .markdown p,
    li,
    ul {
        font-size: large;
    }

    #markdown-toc {
        display: none;
    }
</style>

<!--js-->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } });
    MathJax.Hub.Config({
        tex2jax: {
         inlineMath: [ ['$','$'], ["\\(","\\)"] ],
         processEscapes: true
        }
    });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    type="text/javascript"></script>

<script src="{{ site.baseurl }}/assets/js/particles-bg.js"></script>


<script type="text/javascript">
    $(document).ready(function () {
        function updateTOCOffset() {
            var navEl = document.querySelector('.navbar');
            var baseHeight = navEl ? navEl.getBoundingClientRect().height : 0;
            var offset = Math.max(baseHeight + 16, 96);
            document.documentElement.style.setProperty('--toc-offset', offset + 'px');
        }

        updateTOCOffset();
        window.addEventListener('resize', updateTOCOffset);

        var $tocContainer = $('#toc');
        var sidenavEl = document.querySelector('.sidenav');
        if (!$tocContainer.length) {
            window.addEventListener('load', updateTOCOffset);
            return;
        }

        if (sidenavEl) {
            var tocElement = $tocContainer[0];
            var expandTOC = function () {
                sidenavEl.classList.add('sidenav--expanded');
            };
            var collapseTOC = function () {
                if (!sidenavEl.classList.contains('open')) {
                    sidenavEl.classList.remove('sidenav--expanded');
                }
            };

            tocElement.addEventListener('mouseenter', expandTOC);
            tocElement.addEventListener('mouseleave', collapseTOC);
            tocElement.addEventListener('focusin', expandTOC);
            tocElement.addEventListener('focusout', function (event) {
                var next = event.relatedTarget;
                if (!next || !tocElement.contains(next)) {
                    collapseTOC();
                }
            });
        }

        $tocContainer.toc();

        var $links = $tocContainer.find('a');
        if (!$links.length) {
            return;
        }

        function normalizeHash(hash) {
            if (!hash) return '';
            var raw = hash.trim();
            var hashIndex = raw.indexOf('#');
            if (hashIndex > -1) {
                raw = raw.slice(hashIndex + 1);
            }
            try {
                return decodeURIComponent(raw);
            } catch (e) {
                return raw;
            }
        }

        var linkById = {};
        var headingById = {};
        var headings = [];

        $links.each(function () {
            var href = this.getAttribute('href');
            if (!href || href.charAt(0) !== '#') {
                return;
            }
            var targetId = normalizeHash(href);
            if (!targetId) {
                return;
            }
            var headingEl = document.getElementById(targetId);
            if (!headingEl) {
                return;
            }
            linkById[targetId] = $(this);
            headingById[targetId] = headingEl;
            headings.push(headingEl);
        });

        if (!headings.length) {
            return;
        }

        var activeId = null;
        var SCROLL_OFFSET = 140;
        var SCROLL_PADDING = 32;
        var ANCHOR_SCROLL_OFFSET = 120;
        var SCROLL_DURATION = 180; // milliseconds, ~3x faster than default smooth scroll
        var tocScrollContainer = document.querySelector('.sidenav');
        var activeScrollAnimation = null;

        function ensureVisible($link) {
            if (!tocScrollContainer || !$link || !$link.length) {
                return;
            }

            var target = $link[0];
            var containerRect = tocScrollContainer.getBoundingClientRect();
            var targetRect = target.getBoundingClientRect();

            var above = targetRect.top < containerRect.top + SCROLL_PADDING;
            var below = targetRect.bottom > containerRect.bottom - SCROLL_PADDING;

            if (!above && !below) {
                return;
            }

            var currentScroll = tocScrollContainer.scrollTop;
            var offsetDiff;

            if (above) {
                offsetDiff = targetRect.top - (containerRect.top + SCROLL_PADDING);
            } else {
                offsetDiff = targetRect.bottom - (containerRect.bottom - SCROLL_PADDING);
            }

            var nextScroll = currentScroll + offsetDiff;
            if (nextScroll < 0) {
                nextScroll = 0;
            }

            tocScrollContainer.scrollTo({ top: nextScroll, behavior: 'smooth' });
        }

        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        function animateWindowScroll(targetTop) {
            if (activeScrollAnimation !== null) {
                window.cancelAnimationFrame(activeScrollAnimation);
                activeScrollAnimation = null;
            }

            var start = window.scrollY;
            var distance = targetTop - start;
            if (Math.abs(distance) < 1) {
                window.scrollTo(0, targetTop);
                return;
            }

            var startTime = null;

            function step(timestamp) {
                if (startTime === null) {
                    startTime = timestamp;
                }
                var elapsed = timestamp - startTime;
                var progress = Math.min(elapsed / SCROLL_DURATION, 1);
                var eased = easeInOutCubic(progress);
                window.scrollTo(0, start + distance * eased);
                if (progress < 1) {
                    activeScrollAnimation = window.requestAnimationFrame(step);
                } else {
                    activeScrollAnimation = null;
                }
            }

            activeScrollAnimation = window.requestAnimationFrame(step);
        }

        function scrollToHeading(id, behavior) {
            if (!id || !headingById[id]) {
                return;
            }
            var headingEl = headingById[id];
            var rect = headingEl.getBoundingClientRect();
            var targetTop = rect.top + window.scrollY - ANCHOR_SCROLL_OFFSET;
            if (targetTop < 0) {
                targetTop = 0;
            }
            if (behavior === 'smooth') {
                animateWindowScroll(targetTop);
            } else {
                window.scrollTo(0, targetTop);
            }
        }

        function setActive(id) {
            if (!id || !linkById[id] || id === activeId) {
                return;
            }
            activeId = id;

            $links.removeClass('active');
            $tocContainer.find('li').removeClass('active-ancestor');

            var $activeLink = linkById[id];
            $activeLink.addClass('active');
            $activeLink.parents('li').addClass('active-ancestor');

            window.requestAnimationFrame(function () {
                ensureVisible($activeLink);
            });
        }

        function findActiveId() {
            var scrollPosition = window.scrollY + SCROLL_OFFSET;
            var chosenId = headings[0].id;

            for (var i = 0; i < headings.length; i++) {
                var heading = headings[i];
                var elTop = heading.getBoundingClientRect().top + window.scrollY;
                if (elTop <= scrollPosition) {
                    chosenId = heading.id;
                } else {
                    break;
                }
            }
            return chosenId;
        }

        function updateActive() {
            if (!headings.length) {
                return;
            }
            setActive(findActiveId());
        }

        var ticking = false;
        function handleScroll() {
            if (!ticking) {
                window.requestAnimationFrame(function () {
                    updateActive();
                    ticking = false;
                });
                ticking = true;
            }
        }

        window.addEventListener('scroll', handleScroll, { passive: true });
        window.addEventListener('resize', updateActive);

        window.addEventListener('load', function () {
            updateTOCOffset();
            updateActive();
            var initialId = normalizeHash(window.location.hash || '');
            if (initialId) {
                scrollToHeading(initialId, 'auto');
                setActive(initialId);
            }
        });

        $links.on('click', function (event) {
            var href = this.getAttribute('href');
            if (!href) {
                return;
            }
            var id = normalizeHash(href);
            if (!id) {
                return;
            }
            if (headingById[id]) {
                event.preventDefault();
                if (history.pushState) {
                    history.pushState(null, '', '#' + encodeURIComponent(id));
                    scrollToHeading(id, 'smooth');
                } else {
                    window.location.hash = id;
                    setTimeout(function () {
                        scrollToHeading(id, 'auto');
                    }, 0);
                }
            }
            setActive(id);
            if (event.detail !== 0 && typeof this.blur === 'function') {
                this.blur();
            }
        });

        window.addEventListener('hashchange', function () {
            var id = normalizeHash(window.location.hash || '');
            if (id) {
                setActive(id);
                scrollToHeading(id, 'auto');
            }
        });

        updateActive();
        updateTOCOffset();
        var initialHashId = normalizeHash(window.location.hash || '');
        if (initialHashId) {
            scrollToHeading(initialHashId, 'auto');
            setActive(initialHashId);
        }
    });
</script>

<!-- Mobile TOC expand/collapse (tap to open on small screens) -->
<script type="text/javascript">
    (function () {
        function initMobileTOCToggle() {
            var sidenav = document.querySelector('.sidenav');
            if (!sidenav) return;
            function isMobile() { return window.innerWidth <= 880; }

            // Close when clicking outside
            document.addEventListener('click', function (e) {
                if (!isMobile()) return;
                if (!sidenav.contains(e.target)) {
                    sidenav.classList.remove('open');
                    sidenav.classList.remove('sidenav--expanded');
                }
            });

            // Toggle open on tap/click inside collapsed rail
            sidenav.addEventListener('click', function (e) {
                if (!isMobile()) return;
                // If already open, allow normal link clicks
                if (sidenav.classList.contains('open')) return;
                // Prevent immediate navigation on first tap when collapsed
                var target = e.target.closest('a');
                if (target) {
                    e.preventDefault();
                }
                sidenav.classList.add('open');
                sidenav.classList.add('sidenav--expanded');
            });

            // Auto-close when pointer leaves the expanded sidenav
            sidenav.addEventListener('mouseleave', function () {
                if (!isMobile()) return;
                sidenav.classList.remove('open');
                sidenav.classList.remove('sidenav--expanded');
            });

            // Close after clicking a TOC link to return to content
            sidenav.addEventListener('click', function (e) {
                if (!isMobile()) return;
                var link = e.target.closest('a');
                if (link && sidenav.classList.contains('open')) {
                    setTimeout(function () {
                        sidenav.classList.remove('open');
                        sidenav.classList.remove('sidenav--expanded');
                    }, 0);
                }
            });

            // Adapt on resize (remove open state when leaving mobile)
            window.addEventListener('resize', function () {
                if (!isMobile()) {
                    sidenav.classList.remove('open');
                    sidenav.classList.remove('sidenav--expanded');
                }
            });
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMobileTOCToggle);
        } else {
            initMobileTOCToggle();
        }
    })();
</script>

<style>
    .highlight {
        background-color: black;
        border-color: black;
    }
</style>

<!-- Link preview: small popover that appears when hovering links in the markdown content -->
<style>
    /* Popover container */
    .link-preview {
        position: absolute;
        z-index: 99999;
        width: 420px;
        max-width: calc(100vw - 40px);
        max-height: 320px;
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 6px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        overflow: hidden;
        font-size: 13px;
        color: #222;
        display: none;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .link-preview .pp-inner {
        display: flex;
        gap: 10px;
        padding: 12px;
        align-items: flex-start;
    }

    .link-preview .pp-thumbnail {
        width: 120px;
        height: 80px;
        background: #f7f7f7;
        border-radius: 4px;
        overflow: hidden;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .link-preview .pp-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .link-preview .pp-meta {
        flex: 1;
        min-width: 0;
    }

    .link-preview .pp-title {
        margin: 0;
        font-weight: 600;
        font-size: 14px;
        color: #111;
    }

    .link-preview .pp-desc {
        margin-top: 6px;
        color: #444;
        font-size: 12px;
        line-height: 1.3;
        max-height: 120px;
        overflow: auto;
    }

    .link-preview .pp-url {
        margin-top: 8px;
        color: #888;
        font-size: 11px;
        word-break: break-all;
    }

    .link-preview .pp-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        align-items: center;
    }

    .link-preview a.open-link {
        font-size: 12px;
        color: #007bff;
        text-decoration: none;
    }

    .link-preview a.open-link:hover {
        text-decoration: underline;
    }

    /* iframe mode: when an embedded page is displayed */
    .link-preview.iframe-preview {
        padding: 0;
        height: 320px;
        width: 640px;
        max-width: calc(100vw - 40px);
    }

    .link-preview.iframe-preview iframe {
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
    }

    /* small helpers */
    .link-preview .pp-desc::-webkit-scrollbar {
        height: 6px;
    }

    .link-preview .pp-desc::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.08);
        border-radius: 3px;
    }
</style>

<!-- Dark popover overrides -->
<style>
    .link-preview {
        background: linear-gradient(180deg, #0b1220, #0f1724);
        border: 1px solid rgba(255, 255, 255, 0.06);
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.8), 0 2px 8px rgba(0, 0, 0, 0.6);
        color: #e6eef8;
    }

    .link-preview .pp-inner {
        background: transparent;
    }

    .link-preview .pp-thumbnail {
        background: #0b1220;
    }

    .link-preview .pp-title {
        color: #ffffff;
    }

    .link-preview .pp-authors {
        color: #9fb0c9;
    }

    .link-preview .pp-desc {
        color: #cbd5e1;
    }

    .link-preview .pp-url {
        color: #9aa5b3;
    }

    .link-preview a.open-link {
        color: #7dd3fc;
    }

    .link-preview a.open-link:hover {
        color: #9be5ff;
        text-decoration: underline;
    }

    .link-preview .pp-desc::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.06);
    }
</style>

<script type="text/javascript">
    (function ($) {
        $(function () {
            // Create preview element
            var $preview = $(
                '<div class="link-preview" id="link-preview" aria-hidden="true">' +
                '<div class="pp-inner">' +
                '<div class="pp-thumbnail"></div>' +
                '<div class="pp-meta">' +
                '<div class="pp-title"></div>' +
                '<div class="pp-authors"></div>' +
                '<div class="pp-desc"></div>' +
                '<div class="pp-url"></div>' +
                '<div class="pp-actions"></div>' +
                '</div>' +
                '</div>' +
                '</div>'
            );
            // Ensure the preview is attached once
            $('body').append($preview);

            var showTimer = null;
            var hideTimer = null;
            var currentUrl = null;

            function isSameOrigin(url) {
                try {
                    var u = new URL(url, location.href);
                    return u.origin === location.origin;
                } catch (e) {
                    return false;
                }
            }

            function sanitize(str) {
                return (str || '').toString().trim();
            }

            function positionPreview($anchor) {
                var offset = $anchor.offset();
                var anchorHeight = $anchor.outerHeight();
                var previewWidth = $preview.outerWidth();
                var left = offset.left;
                var top = offset.top + anchorHeight + 8;

                var viewportW = $(window).width();
                var viewportH = $(window).height();
                var scrollTop = $(window).scrollTop();

                // Avoid overflowing to the right
                if (left + previewWidth > viewportW - 20) {
                    left = Math.max(20, viewportW - previewWidth - 20);
                }
                // If bottom overflows, show above the anchor
                var previewHeight = $preview.outerHeight();
                if (top - scrollTop + previewHeight > viewportH - 20) {
                    top = offset.top - previewHeight - 8;
                }

                $preview.css({ left: left + 'px', top: top + 'px' });
            }

            function setPreviewContent(data, anchor) {
                data = data || {};
                var title = sanitize(data.title) || sanitize(anchor.attr('title')) || sanitize(anchor.text()) || data.url || '';
                var desc = sanitize(data.desc) || '';
                var url = data.url || anchor.attr('href') || '';

                // If iframe preview requested
                if (data.iframe) {
                    $preview.addClass('iframe-preview');
                    $preview.html('<iframe src="' + url + '"></iframe>');
                    $preview.attr('aria-hidden', 'false');
                    $preview.show();
                    return;
                }

                // Non-iframe (meta) view
                $preview.removeClass('iframe-preview');
                // The inner markup (reset)
                $preview.html(
                    '<div class="pp-inner">' +
                    '<div class="pp-thumbnail"></div>' +
                    '<div class="pp-meta">' +
                    '<div class="pp-title"></div>' +
                    '<div class="pp-authors"></div>' +
                    '<div class="pp-desc"></div>' +
                    '<div class="pp-url"></div>' +
                    '<div class="pp-actions"></div>' +
                    '</div>' +
                    '</div>'
                );

                if (data.image) {
                    var imageUrl = data.image;
                    try { imageUrl = new URL(imageUrl, url).href; } catch (e) { /* ignore */ }
                    $preview.find('.pp-thumbnail').html('<img src="' + imageUrl + '" alt="" />');
                } else {
                    // Leave thumbnail empty or small placeholder
                    $preview.find('.pp-thumbnail').html('');
                }

                $preview.find('.pp-title').text(title);
                if (data.authors) {
                    $preview.find('.pp-authors').text('Authors: ' + data.authors);
                } else {
                    $preview.find('.pp-authors').text('');
                }
                $preview.find('.pp-desc').text(desc);
                $preview.find('.pp-url').text(url);
                $preview.find('.pp-actions').html('<a class="open-link" href="' + url + '" target="_blank" rel="noopener">Open</a>');

                $preview.attr('aria-hidden', 'false');
                $preview.show();
            }

            function fetchPreview(url, anchor) {
                currentUrl = url;
                // Initial placeholder while loading
                setPreviewContent({ title: 'Loading preview...', desc: '', url: url }, anchor);
                positionPreview(anchor);

                // skip mailto / javascript / anchor-only
                if (!url || url.indexOf('mailto:') === 0 || url.indexOf('javascript:') === 0 || url === '#') {
                    setPreviewContent({ title: anchor.text() || url, desc: '(preview not available)', url: url }, anchor);
                    return;
                }

                // If same origin, try to fetch page and parse metadata
                if (isSameOrigin(url)) {
                    $.get(url).done(function (html) {
                        // Use DOMParser for safe parsing
                        try {
                            var parser = new DOMParser();
                            var doc = parser.parseFromString(html, 'text/html');
                            var title = (doc.querySelector("meta[property='og:title']") && doc.querySelector("meta[property='og:title']").getAttribute('content')) || doc.title || '';
                            var desc = (doc.querySelector("meta[property='og:description']") && doc.querySelector("meta[property='og:description']").getAttribute('content')) || (doc.querySelector("meta[name='description']") && doc.querySelector("meta[name='description']").getAttribute('content')) || (doc.querySelector('p') ? doc.querySelector('p').innerText : '');
                            var image = (doc.querySelector("meta[property='og:image']") && doc.querySelector("meta[property='og:image']").getAttribute('content')) || (doc.querySelector('img') && doc.querySelector('img').getAttribute('src')) || null;

                            // Extract authors for arXiv pages (if any)
                            var authors = null;
                            try {
                                if ((new URL(url, location.href)).hostname.indexOf('arxiv.org') !== -1) {
                                    var metaAuthors = doc.querySelectorAll("meta[name='citation_author']");
                                    if (metaAuthors && metaAuthors.length) {
                                        var tmp = [];
                                        for (var i = 0; i < metaAuthors.length; i++) {
                                            var a = metaAuthors[i].getAttribute('content');
                                            if (a) tmp.push(a);
                                        }
                                        if (tmp.length) authors = tmp.join(', ');
                                    } else {
                                        var authEl = doc.querySelector('.authors') || doc.querySelector('div.authors');
                                        if (authEl) {
                                            var ta = authEl.textContent.replace(/^Authors?:/i, '').trim();
                                            if (ta) authors = ta;
                                        }
                                    }
                                }
                            } catch (e) { /* ignore */ }

                            // If results correspond to the most recent request, show them
                            if (currentUrl === url) {
                                setPreviewContent({ title: title, desc: desc, image: image, url: url, authors: authors }, anchor);
                                positionPreview(anchor);
                            }
                        } catch (e) {
                            if (currentUrl === url) {
                                setPreviewContent({ title: anchor.text() || url, desc: '(preview unavailable)', url: url }, anchor);
                            }
                        }
                    }).fail(function () {
                        if (currentUrl === url) {
                            setPreviewContent({ title: anchor.text() || url, desc: '(preview unavailable)', url: url }, anchor);
                        }
                    });
                } else {
                    // external link: show favicon + label immediately, then try to enrich via a CORS proxy
                    var display = anchor.attr('title') || anchor.text() || url;
                    var domain = url;
                    try { domain = new URL(url).hostname; } catch (e) { }

                    // favicon (Google S2) as a cheap thumbnail fallback
                    var favicon = 'https://www.google.com/s2/favicons?domain=' + encodeURIComponent(domain) + '&sz=128';

                    setPreviewContent({ title: display, desc: 'External site — ' + domain, image: favicon, url: url }, anchor);
                    positionPreview(anchor);

                    // Try to fetch metadata via AllOrigins CORS proxy (returns raw HTML)
                    var proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);

                    $.ajax({ url: proxy, method: 'GET', timeout: 8000, dataType: 'text' }).done(function (html) {
                        try {
                            var parser = new DOMParser();
                            var doc = parser.parseFromString(html, 'text/html');
                            var title = (doc.querySelector("meta[property='og:title']") && doc.querySelector("meta[property='og:title']").getAttribute('content')) || doc.title || '';
                            var desc = (doc.querySelector("meta[property='og:description']") && doc.querySelector("meta[property='og:description']").getAttribute('content')) || (doc.querySelector("meta[name='description']") && doc.querySelector("meta[name='description']").getAttribute('content')) || (doc.querySelector('p') ? doc.querySelector('p').innerText : '');
                            var image = (doc.querySelector("meta[property='og:image']") && doc.querySelector("meta[property='og:image']").getAttribute('content')) || (doc.querySelector("meta[name='twitter:image']") && doc.querySelector("meta[name='twitter:image']").getAttribute('content')) || (doc.querySelector('img') && doc.querySelector('img').getAttribute('src')) || null;

                            // Extract authors for arXiv pages (if any)
                            var authors = null;
                            try {
                                if ((new URL(url)).hostname.indexOf('arxiv.org') !== -1) {
                                    var metaAuthors = doc.querySelectorAll("meta[name='citation_author']");
                                    if (metaAuthors && metaAuthors.length) {
                                        var tmp = [];
                                        for (var i = 0; i < metaAuthors.length; i++) {
                                            var a = metaAuthors[i].getAttribute('content');
                                            if (a) tmp.push(a);
                                        }
                                        if (tmp.length) authors = tmp.join(', ');
                                    } else {
                                        var authEl = doc.querySelector('.authors') || doc.querySelector('div.authors');
                                        if (authEl) {
                                            var ta = authEl.textContent.replace(/^Authors?:/i, '').trim();
                                            if (ta) authors = ta;
                                        }
                                    }
                                }
                            } catch (e) { /* ignore */ }

                            if (image) {
                                try { image = new URL(image, url).href; } catch (e) { /* ignore */ }
                            }

                            if (currentUrl === url) {
                                // show enriched content only if data found; otherwise keep favicon-based preview
                                if (title || desc || image || authors) {
                                    setPreviewContent({ title: title || display, desc: desc || '', image: image || favicon, url: url, authors: authors }, anchor);
                                    positionPreview(anchor);
                                }
                            }
                        } catch (e) {
                            // parsing error: do nothing, keep fallback
                        }
                    }).fail(function () {
                        // If the proxy fails, try a lightweight plaintext scrape via r.jina.ai (best-effort)
                        try {
                            var jinaUrl = 'https://r.jina.ai/http://' + url.replace(/^https?:\/\//i, '');

                            $.ajax({ url: jinaUrl, method: 'GET', timeout: 7000, dataType: 'text' }).done(function (text) {
                                if (currentUrl === url) {
                                    var summary = '';
                                    if (text) {
                                        summary = text.split('\n').filter(Boolean).slice(0, 4).join(' ');
                                    }
                                    setPreviewContent({ title: display, desc: summary || ('External site — ' + domain), image: favicon, url: url }, anchor);
                                    positionPreview(anchor);
                                }
                            }).fail(function () {
                                // give up silently; keep favicon + domain preview
                            });
                        } catch (e) {
                            // silent
                        }
                    });
                }
            }

            // Hover handlers (delegated): only for links inside the article markdown container
            $('.markdown').on('mouseenter', 'a', function () {
                var $a = $(this);
                var href = $a.attr('href');
                if (!$a || $a.attr('data-no-preview') !== undefined) return; // opt-out attribute

                clearTimeout(hideTimer);
                clearTimeout(showTimer);

                showTimer = setTimeout(function () {
                    fetchPreview(href, $a);
                }, 300);
            }).on('mouseleave', 'a', function () {
                clearTimeout(showTimer);
                // only hide after a short delay to allow moving into the popover
                hideTimer = setTimeout(function () {
                    $preview.fadeOut(120);
                    $preview.attr('aria-hidden', 'true');
                }, 350);
            });

            // Keep preview visible while hovered
            $(document).on('mouseenter', '.link-preview', function () {
                clearTimeout(hideTimer);
            }).on('mouseleave', '.link-preview', function () {
                hideTimer = setTimeout(function () {
                    $preview.fadeOut(120);
                    $preview.attr('aria-hidden', 'true');
                }, 160);
            });

            // Reposition preview on scroll/resize
            $(window).on('scroll resize', function () {
                if ($preview.is(':visible') && $('.markdown a:hover').length) {
                    positionPreview($('.markdown a:hover').first());
                }
            });

        });
    })(jQuery);
</script>